<!DOCTYPE html>
<html>
<head>
    <title>Reconocimiento de Dígitos con Matriz de Valores</title>
 <link rel="stylesheet" href="../Dígitos Manuscritos mediante red neuronal convolucional\slyles.css"/>
</head>
<body>
    <h1>Dibuja un dígito (0-9)</h1>
    
    <div id="canvas-container">
        <canvas id="canvas" width="280" height="280"></canvas>
    </div>
    
    <div class="controls">
        <button id="clear">Limpiar</button>
        <button id="predict">Predecir</button>
    </div>
    
    <div id="result"></div>
    
    <div id="pixel-viewer">
        <h3>Vista de píxeles (28×28)</h3>
        <p>Representación visual:</p>
        <div id="pixel-grid"></div>
    </div>

    <div id="matrix-viewer">
        <h3>Matriz de Valores (Grises Normalizados 0.0-1.0)</h3>
        <div id="value-matrix"></div>
    </div>

    <div class="tooltip" id="tooltip" style="display: none;"></div>

    <script>
        // Configuración del canvas
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        const tooltip = document.getElementById('tooltip');
        
        // Inicializar canvas
        function initCanvas() {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 20;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }
        initCanvas();

        // Eventos de dibujo
        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDrawing) {
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('mouseout', () => isDrawing = false);

        // Botones
        document.getElementById('clear').addEventListener('click', () => {
            initCanvas();
            document.getElementById('result').innerHTML = '';
            document.getElementById('pixel-grid').innerHTML = '';
            document.getElementById('value-matrix').innerHTML = '';
        });

        document.getElementById('predict').addEventListener('click', predictDigit);

        // Función principal
        async function predictDigit() {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = 28;
            tempCanvas.height = 28;
            
            // Escalar y obtener datos
            tempCtx.drawImage(canvas, 0, 0, 28, 28);
            const imgData = tempCtx.getImageData(0, 0, 28, 28);
            
            // Mostrar píxeles y matriz
            showPixelGrid(imgData);
            
            // Enviar al servidor
            try {
                const pixels = [];
                for (let i = 0; i < imgData.data.length; i += 4) {
                    const gray = (imgData.data[i] + imgData.data[i+1] + imgData.data[i+2]) / 3;
                    pixels.push((gray / 255).toFixed(2));
                }
                
                const response = await fetch('http://localhost:8000', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `pixeles=${pixels.join(',')}`
                });
                
                const data = await response.json();
                showResult(data);
            } catch (error) {
                document.getElementById('result').innerHTML = 
                    '<p style="color:red">Error al conectar con el servidor</p>';
            }
        }

        // Mostrar grilla de píxeles y matriz de valores
        function showPixelGrid(imgData) {
            const grid = document.getElementById('pixel-grid');
            const matrixDiv = document.getElementById('value-matrix');
            grid.innerHTML = '';
            matrixDiv.innerHTML = '';

            // Crear tabla para la matriz numérica
            const table = document.createElement('table');
            const matrixData = [];

            for (let y = 0; y < 28; y++) {
                const row = document.createElement('tr');
                const matrixRow = [];
                
                for (let x = 0; x < 28; x++) {
                    const i = (y * 28 + x) * 4;
                    const r = imgData.data[i];
                    const g = imgData.data[i+1];
                    const b = imgData.data[i+2];
                    const gray = (r + g + b) / 3;
                    const normalized = (gray / 255).toFixed(2);

                    // 1. Grid visual (existente)
                    const pixel = document.createElement('div');
                    pixel.className = 'pixel';
                    pixel.style.backgroundColor = `rgba(${r}, ${g}, ${b}, 1)`;
                    pixel.addEventListener('mousemove', (e) => {
                        tooltip.style.display = 'block';
                        tooltip.style.left = `${e.pageX}px`;
                        tooltip.style.top = `${e.pageY}px`;
                        tooltip.innerHTML = `Pos: (${x},${y})<br>Valor: ${normalized}`;
                        
                        // Resaltar celda correspondiente en la matriz
                        const cells = table.querySelectorAll('td');
                        cells.forEach(cell => cell.style.backgroundColor = '');
                        const cellIndex = y * 28 + x;
                        cells[cellIndex].style.backgroundColor = '#ffeb3b';
                    });
                    
                    pixel.addEventListener('mouseout', () => {
                        tooltip.style.display = 'none';
                    });
                    
                    grid.appendChild(pixel);

                    // 2. Matriz numérica (nueva)
                    const cell = document.createElement('td');
                    cell.textContent = normalized;
                    cell.title = `RGB: ${r},${g},${b} | Gris: ${gray.toFixed(0)}`;
                    row.appendChild(cell);
                    matrixRow.push(normalized);
                }
                
                table.appendChild(row);
                matrixData.push(matrixRow);
            }
            
            matrixDiv.appendChild(table);
            console.log("Matriz de valores:", matrixData); // Para debug
        }

        // Mostrar resultados
        function showResult(data) {
            const resultDiv = document.getElementById('result');
            const confidencePercent = (data.confidence * 100).toFixed(1);
            
            resultDiv.innerHTML = `
                <p>Predicción: <strong>${data.digit}</strong></p>
                <p>Confianza: <strong>${confidencePercent}%</strong></p>
                ${data.confidence < 0.6 ? '<p style="color:orange">¿Dibujaste el número claramente?</p>' : ''}
            `;
        }
    </script>
</body>
</html>